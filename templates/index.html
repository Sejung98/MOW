{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤</h2>
    <p>MOW ì¬ê³  ë° ì¬ë¬´ ê´€ë¦¬ ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
    <p>ì´ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ì—¬ ì œí’ˆ ì¬ê³  ê´€ë¦¬, íŒë§¤ ê¸°ë¡, ì¬ë¬´ ë³´ê³ ì„œë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div style="margin-top: 2rem;">
        <a href="{{ url_for('generate_dummy_data') }}" class="btn btn-secondary" style="margin-right: 1rem;">
            ğŸ“Š ë”ë¯¸ ë°ì´í„° ìƒì„±
        </a>
        <span style="color: #666; font-size: 0.9rem;">í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤</span>
    </div>
</div>

<div class="stats">
    <div class="stat-card">
        <h4>ğŸ“¦ ë“±ë¡ëœ ì œí’ˆ</h4>
        <div class="stat-value" id="product-count">-</div>
        <div class="stat-subtitle">ê°œì˜ ìƒí’ˆì´ ë“±ë¡ë¨</div>
    </div>
    <div class="stat-card">
        <h4>ğŸ’° ì´ ì¬ê³  ê°€ì¹˜</h4>
        <div class="stat-value" id="inventory-value">-</div>
        <div class="stat-subtitle">ì› ìƒë‹¹ì˜ ì¬ê³ </div>
    </div>
    <div class="stat-card">
        <h4>ğŸ’µ í˜„ê¸ˆ ì”ì•¡</h4>
        <div class="stat-value" id="cash-balance">-</div>
        <div class="stat-subtitle">ì› ë³´ìœ  ì¤‘</div>
    </div>
    <div class="stat-card">
        <h4>ğŸ“ˆ ì´ë²ˆ ë‹¬ ìˆ˜ìµ</h4>
        <div class="stat-value" id="monthly-revenue">-</div>
        <div class="stat-subtitle">ì› ë§¤ì¶œ ë‹¬ì„±</div>
    </div>
</div>

<script>
// ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
function showLoading(element) {
    element.innerHTML = '<div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #667eea; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div>';
}

function hideLoading(element, content) {
    element.innerHTML = content;
}

// ìˆ«ì ì¹´ìš´íŠ¸ ì• ë‹ˆë©”ì´ì…˜
function animateNumber(element, targetValue, suffix = '', prefix = '') {
    const startValue = 0;
    const duration = 1000;
    const startTime = performance.now();

    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // ì´ì§• í•¨ìˆ˜ (ease-out)
        const easeOutProgress = 1 - Math.pow(1 - progress, 3);

        const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutProgress);
        element.textContent = prefix + currentValue.toLocaleString() + suffix;

        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }

    requestAnimationFrame(update);
}

async function loadStats() {
    const statElements = {
        'product-count': { loading: true, suffix: 'ê°œ' },
        'inventory-value': { loading: true, prefix: 'â‚©', suffix: 'ì›' },
        'cash-balance': { loading: true, prefix: 'â‚©', suffix: 'ì›' },
        'monthly-revenue': { loading: true, prefix: 'â‚©', suffix: 'ì›' }
    };

    // ë¡œë”© í‘œì‹œ
    Object.keys(statElements).forEach(id => {
        const element = document.getElementById(id);
        if (statElements[id].loading) {
            showLoading(element);
        }
    });

    try {
        const [productsRes, salesRes] = await Promise.all([
            fetch('/api/products'),
            fetch('/api/sales')
        ]);

        const products = await productsRes.json();
        const sales = await salesRes.json();

        // ì œí’ˆ ìˆ˜ ì—…ë°ì´íŠ¸
        animateNumber(document.getElementById('product-count'), products.length, 'ê°œ');

        // ì¬ê³  ê°€ì¹˜ ê³„ì‚°
        const inventoryValue = products.reduce((sum, p) => sum + (p.stock * p.cost), 0);
        animateNumber(document.getElementById('inventory-value'), inventoryValue, 'ì›', 'â‚©');

        // ì´ë²ˆ ë‹¬ íŒë§¤ ê³„ì‚°
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const monthlySales = sales.filter(s => s.sale_date.startsWith(currentMonth));
        const monthlyRevenue = monthlySales.reduce((sum, s) => sum + (s.quantity * s.sale_price), 0);
        animateNumber(document.getElementById('monthly-revenue'), monthlyRevenue, 'ì›', 'â‚©');

        // í˜„ê¸ˆ ì”ì•¡ (ê°„ë‹¨í•œ ê³„ì‚° - ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ ë¡œì§ í•„ìš”)
        const cashBalance = monthlyRevenue * 0.8; // ë§¤ì¶œì˜ 80%ë¥¼ í˜„ê¸ˆìœ¼ë¡œ ê°€ì •
        animateNumber(document.getElementById('cash-balance'), cashBalance, 'ì›', 'â‚©');

    } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        // ì—ëŸ¬ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
        Object.keys(statElements).forEach(id => {
            const element = document.getElementById(id);
            element.textContent = 'ì˜¤ë¥˜';
        });
    }
}

// CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
const style = document.createElement('style');
style.textContent = `
@keyframes spin {
    to { transform: rotate(360deg); }
}

.stat-card {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
    transform: translateY(20px);
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }
.stat-card:nth-child(4) { animation-delay: 0.4s; }

@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
`;
document.head.appendChild(style);

// í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ë¡œë“œ
document.addEventListener('DOMContentLoaded', loadStats);
</script>
{% endblock %}
